<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ghp â€” Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #0d1117; color: #c9d1d9; }
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid #30363d; margin-bottom: 2rem; }
        header h1 { font-size: 1.25rem; color: #f0f6fc; }
        .user-info { display: flex; align-items: center; gap: 1rem; }
        .user-info span { color: #8b949e; }
        .btn { display: inline-block; background: #238636; color: #fff; padding: 0.5rem 1rem; border-radius: 6px; text-decoration: none; font-weight: 600; border: none; cursor: pointer; font-size: 0.875rem; }
        .btn:hover { background: #2ea043; }
        .btn-danger { background: #da3633; }
        .btn-danger:hover { background: #f85149; }
        .btn-secondary { background: #21262d; border: 1px solid #30363d; }
        .btn-secondary:hover { background: #30363d; }
        .section { margin-bottom: 2rem; }
        .section h2 { font-size: 1.1rem; color: #f0f6fc; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #30363d; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #21262d; font-size: 0.875rem; }
        th { color: #8b949e; font-weight: 600; }
        .badge { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
        .badge-active { background: rgba(35,134,54,0.2); color: #3fb950; }
        .badge-expired { background: rgba(218,54,51,0.2); color: #f85149; }
        .badge-revoked { background: rgba(139,148,158,0.2); color: #8b949e; }
        .create-form { background: #161b22; border: 1px solid #30363d; border-radius: 6px; padding: 1.5rem; margin-bottom: 2rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: #8b949e; }
        .form-group input, .form-group select { width: 100%; padding: 0.5rem; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-size: 0.875rem; }
        .token-display { background: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 1rem; margin-top: 1rem; font-family: monospace; word-break: break-all; }
        #token-list { min-height: 100px; }
        .empty { text-align: center; color: #8b949e; padding: 2rem; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ghp</h1>
            <div class="user-info">
                <span>{{ .Username }} ({{ .Role }})</span>
                {{ if eq .Role "admin" }}<a href="/admin" class="btn btn-secondary">Admin</a>{{ end }}
                <button class="btn btn-secondary" onclick="logout()">Sign out</button>
            </div>
        </header>

        <div class="section">
            <h2>Create Token</h2>
            <div class="create-form">
                <div class="form-group">
                    <label for="repo">Repository (owner/repo)</label>
                    <input type="text" id="repo" placeholder="org/repository">
                </div>
                <div class="form-group">
                    <label for="scopes">Scopes (comma-separated)</label>
                    <input type="text" id="scopes" placeholder="contents:read,pulls:write,issues:write">
                </div>
                <div class="form-group">
                    <label for="duration">Duration</label>
                    <select id="duration">
                        <option value="8h">8 hours</option>
                        <option value="24h" selected>24 hours</option>
                        <option value="48h">48 hours</option>
                        <option value="168h">7 days</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="session">Session identifier (optional)</label>
                    <input type="text" id="session" placeholder="claude-code-feature-123">
                </div>
                <button class="btn" onclick="createToken()">Create Token</button>
                <div id="new-token" style="display:none">
                    <div class="token-display" id="token-value"></div>
                    <p style="color:#f0883e;margin-top:0.5rem;font-size:0.8rem">This token will only be shown once. Copy it now.</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Active Tokens</h2>
            <div id="token-list"></div>
        </div>

        <div class="section">
            <h2>Audit Log</h2>
            <div id="audit-log"></div>
        </div>
    </div>

    <script>
        function getCookie(name) {
            const v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
            return v ? v[2] : null;
        }

        async function api(method, path, body) {
            const opts = { method, headers: { 'Content-Type': 'application/json' } };
            if (body) opts.body = JSON.stringify(body);
            const resp = await fetch(path, opts);
            return resp.json();
        }

        async function createToken() {
            const repo = document.getElementById('repo').value;
            const scopes = document.getElementById('scopes').value;
            const duration = document.getElementById('duration').value;
            const session = document.getElementById('session').value;

            if (!repo || !scopes) { alert('Repository and scopes are required'); return; }

            const data = await api('POST', '/api/tokens', { repository: repo, scopes, duration, session_id: session });
            if (data.token) {
                document.getElementById('token-value').textContent = data.token;
                document.getElementById('new-token').style.display = 'block';
                loadTokens();
            } else {
                alert(data.message || 'Failed to create token');
            }
        }

        async function revokeToken(id) {
            if (!confirm('Revoke this token?')) return;
            await api('DELETE', '/api/tokens/' + id);
            loadTokens();
        }

        async function loadTokens() {
            const tokens = await api('GET', '/api/tokens');
            const container = document.getElementById('token-list');

            if (!Array.isArray(tokens) || tokens.length === 0) {
                container.innerHTML = '<div class="empty">No tokens found</div>';
                return;
            }

            let html = '<table><tr><th>ID</th><th>Repository</th><th>Scopes</th><th>Session</th><th>Status</th><th>Requests</th><th>Expires</th><th></th></tr>';
            for (const t of tokens) {
                const now = new Date();
                const expires = new Date(t.expires_at);
                let status, badge;
                if (t.revoked_at) { status = 'Revoked'; badge = 'badge-revoked'; }
                else if (expires < now) { status = 'Expired'; badge = 'badge-expired'; }
                else { status = 'Active'; badge = 'badge-active'; }

                const scopes = typeof t.scopes === 'string' ? t.scopes : JSON.stringify(t.scopes);
                html += '<tr>';
                html += '<td>' + t.token_prefix + '...</td>';
                html += '<td>' + (t.repository || '') + '</td>';
                html += '<td>' + scopes + '</td>';
                html += '<td>' + (t.session_id || '-') + '</td>';
                html += '<td><span class="badge ' + badge + '">' + status + '</span></td>';
                html += '<td>' + (t.request_count || 0) + '</td>';
                html += '<td>' + expires.toLocaleString() + '</td>';
                html += '<td>' + (status === 'Active' ? '<button class="btn btn-danger" onclick="revokeToken(\'' + t.id + '\')">Revoke</button>' : '') + '</td>';
                html += '</tr>';
            }
            html += '</table>';
            container.innerHTML = html;
        }

        async function loadAudit() {
            const entries = await api('GET', '/api/audit');
            const container = document.getElementById('audit-log');

            if (!Array.isArray(entries) || entries.length === 0) {
                container.innerHTML = '<div class="empty">No audit entries</div>';
                return;
            }

            let html = '<table><tr><th>Time</th><th>Action</th><th>Method</th><th>Path</th><th>Repository</th><th>Status</th><th>Duration</th></tr>';
            for (const e of entries.slice(0, 50)) {
                const ts = new Date(e.timestamp).toLocaleString();
                html += '<tr>';
                html += '<td>' + ts + '</td>';
                html += '<td>' + e.action + '</td>';
                html += '<td>' + (e.method || '-') + '</td>';
                html += '<td>' + (e.path || '-') + '</td>';
                html += '<td>' + (e.repository || '-') + '</td>';
                html += '<td>' + (e.status_code || '-') + '</td>';
                html += '<td>' + (e.duration_ms ? e.duration_ms + 'ms' : '-') + '</td>';
                html += '</tr>';
            }
            html += '</table>';
            container.innerHTML = html;
        }

        async function logout() {
            await api('POST', '/auth/logout');
            window.location.href = '/login';
        }

        loadTokens();
        loadAudit();
    </script>
</body>
</html>
