name: Test

on:
  pull_request:
    branches: [main, master]

permissions:
  contents: read
  pull-requests: write

jobs:
  unit-tests:
    name: Go unit tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Run tests
        run: go test ./...

      - name: Build binary
        run: CGO_ENABLED=0 go build -o ghp ./cmd/ghp

      - name: Verify binary runs
        run: ./ghp version

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: ghp-binary
          path: ghp
          retention-days: 1

  e2e-tests:
    name: Playwright E2E tests
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: ghp-binary

      - name: Make binary executable
        run: chmod +x ./ghp

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Playwright dependencies
        working-directory: e2e
        run: |
          npm ci
          npx playwright install --with-deps chromium

      - name: Generate encryption key
        id: enckey
        run: echo "key=$(openssl rand -hex 32)" >> "$GITHUB_OUTPUT"

      - name: Run database migrations
        env:
          GHP_DATABASE_DRIVER: sqlite
          GHP_DATABASE_DSN: /tmp/ghp-test.db
        run: ./ghp migrate

      - name: Start ghp server
        env:
          GHP_DATABASE_DRIVER: sqlite
          GHP_DATABASE_DSN: /tmp/ghp-test.db
          GHP_ENCRYPTION_KEY: ${{ steps.enckey.outputs.key }}
          GHP_SERVER_LISTEN: ":8080"
          GHP_DEV_MODE: "true"
          GHP_GITHUB_CLIENT_ID: "test-client-id"
          GHP_GITHUB_CLIENT_SECRET: "test-client-secret"
        run: |
          ./ghp serve &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> "$GITHUB_ENV"

          # Wait for server to be ready.
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8080/auth/status > /dev/null 2>&1; then
              echo "Server is ready"
              break
            fi
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo "Server process died"
              exit 1
            fi
            echo "Waiting for server... ($i/30)"
            sleep 1
          done

      - name: Run Playwright tests
        id: playwright
        working-directory: e2e
        env:
          GHP_BASE_URL: http://localhost:8080
        run: npx playwright test
        continue-on-error: true

      - name: Stop server
        if: always()
        run: |
          if [ -n "$SERVER_PID" ]; then
            kill $SERVER_PID 2>/dev/null || true
          fi

      - name: Upload screenshots and report
        if: always()
        id: artifacts
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results
          path: |
            e2e/test-results/
            e2e/playwright-report/
          retention-days: 14

      - name: Comment on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          PLAYWRIGHT_OUTCOME: ${{ steps.playwright.outcome }}
        with:
          script: |
            const fs = require('fs');

            // Parse Playwright JSON results if available.
            let results = null;
            const resultsPath = 'e2e/test-results/results.json';
            try {
              results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
            } catch {
              // Results file may not exist if Playwright crashed early.
            }

            let passed = 0, failed = 0, skipped = 0, total = 0;
            const testRows = [];

            function processSuite(suite, parentTitle) {
              const title = parentTitle ? `${parentTitle} ‚Ä∫ ${suite.title}` : suite.title;
              for (const spec of (suite.specs || [])) {
                for (const test of (spec.tests || [])) {
                  total++;
                  const result = test.results[test.results.length - 1];
                  const status = result ? result.status : 'unknown';
                  const duration = result ? (result.duration / 1000).toFixed(1) : '?';
                  if (status === 'passed' || status === 'expected') {
                    passed++;
                    testRows.push(`| ${title} ‚Ä∫ ${spec.title} | ‚úÖ Pass | ${duration}s |`);
                  } else if (status === 'failed' || status === 'timedOut' || status === 'unexpected') {
                    failed++;
                    testRows.push(`| ${title} ‚Ä∫ ${spec.title} | ‚ùå Fail | ${duration}s |`);
                  } else {
                    skipped++;
                    testRows.push(`| ${title} ‚Ä∫ ${spec.title} | ‚è≠Ô∏è Skip | ${duration}s |`);
                  }
                }
              }
              for (const child of (suite.suites || [])) {
                processSuite(child, title);
              }
            }

            if (results) {
              for (const suite of (results.suites || [])) {
                processSuite(suite, '');
              }
            }

            const outcome = process.env.PLAYWRIGHT_OUTCOME;
            const statusEmoji = outcome === 'success' ? '‚úÖ' : '‚ùå';
            const statusText = outcome === 'success' ? 'Passed' : 'Failed';

            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const artifactUrl = `${runUrl}#artifacts`;

            let body = `<!-- ghp-e2e-results -->\n`;
            body += `## ${statusEmoji} E2E Test Results ‚Äî ${statusText}\n\n`;

            if (results) {
              body += `| Total | Passed | Failed | Skipped |\n`;
              body += `|------:|-------:|-------:|--------:|\n`;
              body += `| ${total} | ${passed} | ${failed} | ${skipped} |\n\n`;

              if (testRows.length > 0) {
                body += `<details>\n<summary>Test Details</summary>\n\n`;
                body += `| Test | Status | Duration |\n`;
                body += `|------|--------|----------|\n`;
                body += testRows.join('\n') + '\n';
                body += `\n</details>\n\n`;
              }
            } else {
              body += `> ‚ö†Ô∏è Playwright results file not found ‚Äî the test runner may have crashed before producing output.\n\n`;
            }

            body += `üì∏ **Screenshots & report**: [Download artifacts](${artifactUrl})\n`;
            body += `üìä **Workflow run**: [View details](${runUrl})\n\n`;
            body += `_Run [#${context.runNumber}](${runUrl}) ¬∑ ${new Date().toISOString().replace('T', ' ').slice(0, 19)} UTC_\n`;

            // Find existing comment with our marker.
            const marker = '<!-- ghp-e2e-results -->';
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c => c.body && c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
              core.info(`Updated existing comment ${existing.id}`);
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
              core.info('Created new PR comment');
            }

            // Write the same summary to the workflow step summary.
            await core.summary
              .addRaw(body)
              .write();

      - name: Fail if tests failed
        if: always() && steps.playwright.outcome != 'success'
        run: exit 1
